<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalcer Watch Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-beat { animation: heartbeat 1s infinite; }
        @keyframes heartbeat { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <nav class="bg-white border-b border-slate-100 px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
        <div class="flex items-center gap-2">
            <i class="ph-fill ph-watch text-indigo-600 text-2xl"></i>
            <span class="font-bold text-xl text-slate-800 tracking-tight">Kalcer Watch</span>
        </div>
        <a href="/contacts" class="flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition bg-slate-100 px-4 py-2 rounded-full hover:bg-indigo-50">
            <i class="ph ph-address-book text-lg"></i>
            <span>Kontak Darurat</span>
        </a>
    </nav>

    <div class="max-w-6xl mx-auto px-4 mt-8">
        
        <div class="flex justify-between items-end mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Live Monitoring</h1>
                <p class="text-slate-500 text-sm flex items-center gap-2" id="lastUpdate">
                    <span class="flex h-3 w-3 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    Menunggu Data...
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:border-indigo-100 transition">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i class="ph-fill ph-heart text-9xl text-rose-500"></i>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="bg-rose-100 p-2 rounded-lg text-rose-600">
                        <i class="ph-fill ph-heart-beat text-xl"></i>
                    </div>
                    <span class="text-sm font-semibold text-slate-500">Heart Rate</span>
                </div>
                <div class="flex items-baseline gap-1 mt-2">
                    <span id="bpmValue" class="text-4xl font-bold text-slate-800">--</span>
                    <span class="text-sm text-slate-400">BPM</span>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span id="bpmIndicator" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-500 font-medium">--</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <div class="bg-blue-100 p-2 rounded-lg text-blue-600">
                            <i class="ph-fill ph-person-simple-run text-xl"></i>
                        </div>
                        <span class="text-sm font-semibold text-slate-500">Aktivitas</span>
                    </div>
                    <div class="bg-orange-50 text-orange-600 px-2 py-1 rounded-lg text-xs font-bold flex items-center gap-1">
                        <i class="ph-bold ph-thermometer"></i>
                        <span id="tempValue">--</span>°C
                    </div>
                </div>
                <div class="mt-2">
                    <span id="activityValue" class="text-2xl font-bold text-slate-800">--</span>
                </div>
                <p class="text-xs text-slate-400 mt-1">Status gerakan pengguna</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-2">
                    <div class="bg-amber-100 p-2 rounded-lg text-amber-600">
                        <i class="ph-fill ph-warning-circle text-xl"></i>
                    </div>
                    <span class="text-sm font-semibold text-slate-500">Status Bahaya</span>
                </div>
                <div class="mt-2">
                    <span id="anomalyValue" class="text-2xl font-bold text-slate-800">--</span>
                </div>
                <p id="anomalyDesc" class="text-xs text-slate-400 mt-1">Sistem berjalan normal</p>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex items-center gap-2 mb-2">
                    <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                        <i class="ph-fill ph-activity text-xl"></i>
                    </div>
                    <span class="text-sm font-semibold text-slate-500">Intensitas (G)</span>
                </div>
                <div class="flex justify-between items-end mt-2">
                    <span id="magValue" class="text-2xl font-bold text-slate-800">0.0</span>
                    <span class="text-xs text-slate-400 mb-1">m/s²</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 mt-3 overflow-hidden">
                    <div id="magBar" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                        <i class="ph-bold ph-chart-line-up"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">Tren Detak Jantung & Gerakan</h3>
                </div>
                <button onclick="loadHistory()" class="text-xs font-medium text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-lg transition border border-indigo-100">
                    <i class="ph-bold ph-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="relative h-80 w-full">
                <canvas id="healthChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- CHART CONFIG ---
        const ctx = document.getElementById('healthChart').getContext('2d');
        let gradientHR = ctx.createLinearGradient(0, 0, 0, 400);
        gradientHR.addColorStop(0, 'rgba(244, 63, 94, 0.5)');
        gradientHR.addColorStop(1, 'rgba(244, 63, 94, 0.0)');

        let myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Heart Rate (BPM)',
                    data: [],
                    borderColor: '#f43f5e',
                    backgroundColor: gradientHR,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2,
                    borderWidth: 2
                }, {
                    label: 'Intensitas (m/s²)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'transparent',
                    tension: 0.4,
                    pointRadius: 0, 
                    borderWidth: 1,
                    borderDash: [5, 5]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // --- FETCH REALTIME ---
        function updateRealtime() {
            fetch('/api/current-data')
                .then(response => response.json())
                .then(data => {
                    // 1. Heart Rate & Stability
                    const bpmEl = document.getElementById('bpmValue');
                    const bpmInd = document.getElementById('bpmIndicator');
                    bpmEl.innerText = data.heartRate || 0;
                    
                    if(data.hrStable) {
                        bpmInd.className = "text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-medium border border-emerald-200";
                        bpmInd.innerHTML = "<i class='ph-fill ph-check-circle'></i> Detak Stabil";
                        bpmEl.classList.remove('animate-beat');
                    } else {
                        bpmInd.className = "text-xs px-2 py-1 rounded-full bg-rose-100 text-rose-700 font-medium border border-rose-200";
                        bpmInd.innerHTML = "<i class='ph-fill ph-warning'></i> Tidak Stabil";
                        bpmEl.classList.add('animate-beat');
                    }

                    // 2. Activity & Temperature
                    document.getElementById('activityValue').innerText = data.activity || 'Diam';
                    if(data.temperature) {
                        document.getElementById('tempValue').innerText = data.temperature.toFixed(1);
                    }

                    // 3. Anomaly Handling (Menggunakan boolean isAnomalous)
                    const anomEl = document.getElementById('anomalyValue');
                    const anomDesc = document.getElementById('anomalyDesc');
                    
                    // Priority: Cek boolean isAnomalous, atau string anomaly != "Normal"
                    if(data.isAnomalous === true || (data.anomaly && data.anomaly !== "Normal")) {
                        anomEl.innerText = data.anomaly || "BAHAYA";
                        anomEl.className = "text-2xl font-bold text-red-600 animate-pulse";
                        anomDesc.innerText = "Terdeteksi kondisi darurat!";
                        anomDesc.className = "text-xs text-red-500 font-bold mt-1";
                    } else {
                        anomEl.innerText = "Normal";
                        anomEl.className = "text-2xl font-bold text-slate-800";
                        anomDesc.innerText = "Sistem berjalan normal";
                        anomDesc.className = "text-xs text-slate-400 mt-1";
                    }

                    // 4. Magnitude
                    const mag = data.magnitude || 0;
                    document.getElementById('magValue').innerText = mag.toFixed(2);
                    const percent = Math.min((mag / 10) * 100, 100); // Scale max 10 m/s2
                    document.getElementById('magBar').style.width = percent + '%';

                    // 5. Timestamp update
                    if(data.timestamp) {
                        document.getElementById('lastUpdate').innerHTML = `
                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            Update: ${data.timestamp.split(' ')[1]}
                        `;
                    }
                })
                .catch(err => console.error("Realtime Error:", err));
        }

        // --- FETCH HISTORY ---
        function loadHistory() {
            fetch('/api/history-data')
                .then(res => res.json())
                .then(d => {
                    if(d.labels && d.labels.length > 0){
                        myChart.data.labels = d.labels;
                        myChart.data.datasets[0].data = d.heartRate;
                        myChart.data.datasets[1].data = d.magnitude;
                        myChart.update();
                    }
                })
                .catch(err => console.error("History Error:", err));
        }

        setInterval(updateRealtime, 1000);
        loadHistory();
        setInterval(loadHistory, 10000);
    </script>
</body>
</html>